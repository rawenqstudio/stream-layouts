<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>WIDOK OBS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: transparent; font-family: 'Segoe UI', sans-serif; }
        #video-container { width: 100%; height: 100%; transition: all 0.5s ease; position: relative; }
        .video-box {
            position: relative; overflow: hidden; border: 2px solid white; box-shadow: 0 0 15px rgba(0,0,0,0.7); background: #000; transition: all 0.5s ease;
        }
        video { width: 100%; height: 100%; object-fit: cover; display: block; }
        .label {
            position: absolute; bottom: 10px; left: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 5px 15px; border-radius: 4px; font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 2px black; border-left: 4px solid #00d2ff; z-index: 10; display: none;
        }

        /* UKŁADY */
        .layout-grid { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; padding: 20px; box-sizing: border-box; }
        .layout-grid .video-box { width: 45%; height: 45%; } 
        .layout-sidebar-right { display: flex; flex-direction: column; justify-content: center; align-items: flex-end; padding-right: 20px; height: 100vh; }
        .layout-sidebar-right .video-box { width: 320px; height: 180px; margin-bottom: 15px; }
        .layout-bottom { display: flex; flex-direction: row; justify-content: center; align-items: flex-end; padding-bottom: 20px; height: 100vh; }
        .layout-bottom .video-box { width: 280px; height: 157px; margin: 0 10px; }
    </style>
</head>
<body>
    <div id="video-container" class="layout-grid"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const myID = urlParams.get('room') || 'test-room';
        const useStunOnly = urlParams.get('stunonly');

        const fullTurnConfig = [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "turn:openrelay.metered.ca:80?transport=udp", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:80?transport=tcp", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443?transport=udp", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
        ];

        const stunOnlyConfig = [ { urls: "stun:stun.l.google.com:19302" } ];
        const selectedConfig = useStunOnly ? stunOnlyConfig : fullTurnConfig;

        const peer = new Peer(myID, {
            config: { iceServers: selectedConfig },
            debug: 1
        });
        
        const container = document.getElementById('video-container');
        // Mapa do śledzenia czasu ostatniego sygnału "życia" (heartbeat)
        const heartbeats = {}; 

        peer.on('open', (id) => console.log('OBS gotowy. ID: ' + id));

        // 1. Odbieranie WIDEO
        peer.on('call', (call) => {
            call.answer();
            call.on('stream', (remoteStream) => {
                addVideo(remoteStream, call.peer);
            });

            // --- METODA 1: Standardowe zamknięcie ---
            call.on('close', () => removeVideo(call.peer));
            call.on('error', () => removeVideo(call.peer));

            // --- METODA 2: Monitoring ICE (Działa na nagłe rozłączenia) ---
            // Zaglądamy "pod maskę" WebRTC
            const pc = call.peerConnection;
            pc.oniceconnectionstatechange = () => {
                const state = pc.iceConnectionState;
                console.log(`Stan sieci (${call.peer}):`, state);
                if (state === 'disconnected' || state === 'failed' || state === 'closed') {
                    console.log("Wykryto awarię połączenia - usuwanie wideo.");
                    removeVideo(call.peer);
                }
            };
        });

        // 2. Odbieranie DANYCH
        peer.on('connection', (conn) => {
            conn.on('data', (data) => {
                // Heartbeat - Gość żyje
                if(data.type === 'heartbeat') {
                    heartbeats[conn.peer] = Date.now();
                }

                // Layout
                if(data.type === 'layout') container.className = data.mode;

                // Identify
                if(data.type === 'identify') updateLabel(conn.peer, data.name);

                // --- METODA 3: Sygnał "Leave" (Szybkie wyjście) ---
                if(data.type === 'leave') {
                    console.log("Otrzymano sygnał wyjścia.");
                    removeVideo(conn.peer);
                }
            });

            conn.on('close', () => removeVideo(conn.peer));
            conn.on('error', () => removeVideo(conn.peer));
        });

        // --- METODA 4: Strażnik Heartbeat (Sprzątacz) ---
        // Co 3 sekundy sprawdzamy, czy ktoś nie umarł (brak sygnału przez 7 sekund)
        setInterval(() => {
            const now = Date.now();
            for (const peerId in heartbeats) {
                if (now - heartbeats[peerId] > 7000) {
                    console.log(`Brak pulsu od ${peerId} przez 7s - usuwanie.`);
                    removeVideo(peerId);
                    delete heartbeats[peerId];
                }
            }
        }, 3000);

        function addVideo(stream, id) {
            if(document.getElementById(`box-${id}`)) return;

            // Inicjujemy heartbeat
            heartbeats[id] = Date.now();

            const box = document.createElement('div');
            box.className = 'video-box';
            box.id = `box-${id}`;

            const video = document.createElement('video');
            video.srcObject = stream;
            video.muted = true;
            video.autoplay = true;
            video.playsInline = true;
            
            const label = document.createElement('div');
            label.className = 'label';
            label.id = `label-${id}`;

            box.appendChild(video);
            box.appendChild(label);
            container.appendChild(box);

            video.onloadedmetadata = () => {
                video.play().catch(e => console.error("Autoplay:", e));
            };
        }

        function updateLabel(id, name) {
            const label = document.getElementById(`label-${id}`);
            if(label) {
                if (name && name.trim() !== "") {
                    label.innerText = name;
                    label.style.display = 'block';
                } else {
                    label.style.display = 'none';
                }
            }
        }

        function removeVideo(id) {
            const box = document.getElementById(`box-${id}`);
            if(box) {
                console.log(`Usuwanie elementu DOM: ${id}`);
                box.remove();
            }
        }
    </script>
</body>
</html>