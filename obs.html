<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>WIDOK OBS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: transparent;
        font-family: "Segoe UI", sans-serif;
      }

      #video-container {
        width: 100%;
        height: 100%;
        transition: all 0.5s ease;
        position: relative;
      }

      .video-box {
        position: relative;
        overflow: hidden;
        border: 2px solid white;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
        background: #000;
        transition: all 0.5s ease;
      }

      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      /* Ikonki i Podpisy */
      .mute-icon {
        position: absolute;
        top: 10px;
        right: 10px;
        color: red;
        font-size: 24px;
        background: rgba(0, 0, 0, 0.5);
        padding: 5px;
        border-radius: 50%;
        display: none;
        z-index: 20;
      }
      .label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 15px;
        border-radius: 4px;
        font-size: 1.2rem;
        font-weight: bold;
        text-shadow: 1px 1px 2px black;
        border-left: 4px solid #00d2ff;
        z-index: 10;
        display: none;
      }

      /* --- UK≈ÅADY KAMER --- */

      /* 1. Grid (Siatka na ≈õrodku) */
      .layout-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 15px;
        padding: 20px;
        box-sizing: border-box;
      }
      .layout-grid .video-box {
        width: 45%;
        height: 45%;
      }

      /* 2. Pasek Prawy */
      .layout-sidebar-right {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
        padding-right: 20px;
        height: 100vh;
      }
      .layout-sidebar-right .video-box {
        width: 320px;
        height: 180px;
        margin-bottom: 15px;
      }

      /* 3. Pasek Lewy (NOWY) */
      .layout-sidebar-left {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
        padding-left: 20px;
        height: 100vh;
      }
      .layout-sidebar-left .video-box {
        width: 320px;
        height: 180px;
        margin-bottom: 15px;
      }

      /* 4. Pasek Dolny */
      .layout-bottom {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: flex-end;
        padding-bottom: 20px;
        height: 100vh;
      }
      .layout-bottom .video-box {
        width: 280px;
        height: 157px;
        margin: 0 10px;
      }

      /* 5. Pasek G√≥rny (NOWY) */
      .layout-top {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: flex-start;
        padding-top: 20px;
        height: 100vh;
      }
      .layout-top .video-box {
        width: 280px;
        height: 157px;
        margin: 0 10px;
      }

      /* 6. Split / Obie strony (NOWY) */
      /* Rozrzuca kamery po lewej i prawej, zostawiajƒÖc ≈õrodek pusty */
      .layout-split {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-between; /* Kluczowe: rozpycha na boki */
        align-content: center; /* Centruje w pionie ca≈Ço≈õƒá */
        padding: 20px 40px; /* Odstƒôp od krawƒôdzi ekranu */
        height: 100vh;
      }
      .layout-split .video-box {
        width: 300px;
        height: 169px;
        margin-bottom: 30px;
        /* Marginesy, ≈ºeby nie przykleja≈Çy siƒô do siebie w pionie */
      }
    </style>
  </head>
  <body>
    <div id="video-container" class="layout-grid"></div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const myID = urlParams.get("room") || "test-room";
      const useStunOnly = urlParams.get("stunonly");

      // Konfiguracja serwer√≥w (dla obs≈Çugi LTE/4G)
      const selectedConfig = useStunOnly
        ? [{ urls: "stun:stun.l.google.com:19302" }]
        : [
            { urls: "stun:stun.l.google.com:19302" },
            {
              urls: "turn:openrelay.metered.ca:80?transport=udp",
              username: "openrelayproject",
              credential: "openrelayproject",
            },
            {
              urls: "turn:openrelay.metered.ca:80?transport=tcp",
              username: "openrelayproject",
              credential: "openrelayproject",
            },
            {
              urls: "turn:openrelay.metered.ca:443?transport=udp",
              username: "openrelayproject",
              credential: "openrelayproject",
            },
            {
              urls: "turn:openrelay.metered.ca:443?transport=tcp",
              username: "openrelayproject",
              credential: "openrelayproject",
            },
          ];

      const peer = new Peer(myID, { config: { iceServers: selectedConfig } });
      const container = document.getElementById("video-container");

      // --- ZMIENNE GLOBALNE (To naprawia Tw√≥j b≈ÇƒÖd!) ---
      const guests = {}; // Lista go≈õci dla Re≈ºysera
      const heartbeats = {}; // Czas ostatniego sygna≈Çu ≈ºycia
      let directorConn = null; // Po≈ÇƒÖczenie z Re≈ºyserem

      peer.on("open", (id) => console.log("OBS gotowy. ID: " + id));

      // --- 1. ODBI√ìR WIDEO ---
      peer.on("call", (call) => {
        call.answer();
        call.on("stream", (stream) => addVideo(stream, call.peer));

        // Obs≈Çuga roz≈ÇƒÖcze≈Ñ
        call.on("close", () => removeGuest(call.peer));
        call.on("error", () => removeGuest(call.peer));

        // Monitorowanie stanu sieci (szybkie wykrywanie awarii)
        const pc = call.peerConnection;
        pc.oniceconnectionstatechange = () => {
          const s = pc.iceConnectionState;
          if (s === "disconnected" || s === "failed" || s === "closed")
            removeGuest(call.peer);
        };
      });

      // --- 2. ODBI√ìR DANYCH (Sterowanie) ---
      peer.on("connection", (conn) => {
        conn.on("data", (data) => {
          // Re≈ºyser siƒô wita
          if (data.type === "director-hello") {
            console.log("Re≈ºyser po≈ÇƒÖczony.");
            directorConn = conn;
            sendGuestListToDirector();
          }

          // Zmiana uk≈Çadu
          if (data.type === "layout") container.className = data.mode;

          // Re≈ºyser wycisza kogo≈õ
          if (data.type === "remote-mute") {
            if (guests[data.targetId] && guests[data.targetId].conn) {
              guests[data.targetId].conn.send({
                type: "mute-cmd",
                state: data.state,
              });
            }
          }

          // Dane od Go≈õcia
          if (data.type === "identify") {
            guests[conn.peer] = {
              name: data.name || "Go≈õƒá",
              muted: false,
              conn: conn,
            };
            updateLabel(conn.peer, data.name);
            sendGuestListToDirector();
          }

          if (data.type === "mic-status") {
            if (guests[conn.peer]) {
              guests[conn.peer].muted = data.muted;
              toggleMuteIcon(conn.peer, data.muted);
              sendGuestListToDirector();
            }
          }

          // Heartbeat i Wyj≈õcie
          if (data.type === "heartbeat") heartbeats[conn.peer] = Date.now();
          if (data.type === "leave") removeGuest(conn.peer);
        });

        conn.on("close", () => removeGuest(conn.peer));
        conn.on("error", () => removeGuest(conn.peer));
      });

      // --- 3. MECHANIZM HEARTBEAT (Usuwanie duch√≥w) ---
      setInterval(() => {
        const now = Date.now();
        for (const peerId in heartbeats) {
          // Je≈õli brak sygna≈Çu przez 7 sekund, usu≈Ñ
          if (now - heartbeats[peerId] > 7000) {
            console.log(`Brak pulsu od ${peerId} - usuwanie.`);
            removeGuest(peerId);
          }
        }
      }, 3000);

      // --- FUNKCJE POMOCNICZE ---

      function addVideo(stream, id) {
        // Zapobiegaj duplikatom
        if (document.getElementById(`box-${id}`)) return;

        console.log(`Dodajƒô wideo dla ID: ${id}`);
        heartbeats[id] = Date.now(); // Inicjalizacja pulsu

        const box = document.createElement("div");
        box.className = "video-box";
        box.id = `box-${id}`;

        // 1. Element WIDEO (Wyciszony - dla obrazu)
        const video = document.createElement("video");
        video.srcObject = stream;
        video.muted = true; // KLUCZOWE: Muted, ≈ºeby wideo zawsze startowa≈Ço
        video.autoplay = true;
        video.playsInline = true;

        // 2. Element AUDIO (Osobny - dla d≈∫wiƒôku)
        const audio = document.createElement("audio");
        audio.srcObject = stream;
        audio.muted = false; // To ma graƒá!
        audio.autoplay = true;
        audio.id = `audio-${id}`;

        // UI
        const label = document.createElement("div");
        label.className = "label";
        label.id = `label-${id}`;

        const muteIcon = document.createElement("div");
        muteIcon.className = "mute-icon";
        muteIcon.innerText = "üîá";
        muteIcon.id = `mute-${id}`;

        box.appendChild(video);
        box.appendChild(label);
        box.appendChild(muteIcon);
        box.appendChild(audio); // Audio jest w DOM, ale niewidoczne

        container.appendChild(box);

        // Start
        video.play().catch((e) => console.error("Wideo Autoplay error:", e));
        audio
          .play()
          .catch((e) =>
            console.warn(
              "Audio Autoplay zablokowane - wymagana interakcja w OBS!",
              e
            )
          );
      }

      function removeGuest(id) {
        if (document.getElementById(`box-${id}`)) {
          document.getElementById(`box-${id}`).remove();
          delete guests[id];
          delete heartbeats[id];
          sendGuestListToDirector();
        }
      }

      function updateLabel(id, name) {
        const label = document.getElementById(`label-${id}`);
        if (label) {
          if (name && name.trim() !== "") {
            label.innerText = name;
            label.style.display = "block";
          } else {
            label.style.display = "none";
          }
        }
      }

      function toggleMuteIcon(id, isMuted) {
        const icon = document.getElementById(`mute-${id}`);
        if (icon) icon.style.display = isMuted ? "block" : "none";
      }

      function sendGuestListToDirector() {
        if (directorConn && directorConn.open) {
          const safeList = Object.keys(guests).map((id) => ({
            id: id,
            name: guests[id].name,
            muted: guests[id].muted,
          }));
          directorConn.send({ type: "guest-list", list: safeList });
        }
      }
    </script>
  </body>
</html>
