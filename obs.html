<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>WIDOK OBS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: transparent; font-family: 'Segoe UI', sans-serif; }
        #video-container { width: 100%; height: 100%; transition: all 0.5s ease; position: relative; }
        .video-box { position: relative; overflow: hidden; border: 2px solid white; box-shadow: 0 0 15px rgba(0,0,0,0.7); background: #000; transition: all 0.5s ease; }
        video { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        /* Ikonka wyciszenia w OBS */
        .mute-icon {
            position: absolute; top: 10px; right: 10px; color: red; font-size: 24px;
            background: rgba(0,0,0,0.5); padding: 5px; border-radius: 50%;
            display: none; z-index: 20;
        }

        .label {
            position: absolute; bottom: 10px; left: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 5px 15px; border-radius: 4px; font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 2px black; border-left: 4px solid #00d2ff; z-index: 10; display: none;
        }

        .layout-grid { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; padding: 20px; box-sizing: border-box; }
        .layout-grid .video-box { width: 45%; height: 45%; } 
        .layout-sidebar-right { display: flex; flex-direction: column; justify-content: center; align-items: flex-end; padding-right: 20px; height: 100vh; }
        .layout-sidebar-right .video-box { width: 320px; height: 180px; margin-bottom: 15px; }
        .layout-bottom { display: flex; flex-direction: row; justify-content: center; align-items: flex-end; padding-bottom: 20px; height: 100vh; }
        .layout-bottom .video-box { width: 280px; height: 157px; margin: 0 10px; }
    </style>
</head>
<body>
    <div id="video-container" class="layout-grid"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const myID = urlParams.get('room') || 'test-room';
        const useStunOnly = urlParams.get('stunonly');
        const selectedConfig = useStunOnly ? [ { urls: "stun:stun.l.google.com:19302" } ] : [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "turn:openrelay.metered.ca:80?transport=udp", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:80?transport=tcp", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443?transport=udp", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
        ];

        const peer = new Peer(myID, { config: { iceServers: selectedConfig } });
        const container = document.getElementById('video-container');
        
        // Baza danych o goÅ›ciach i poÅ‚Ä…czeniach
        // Struktura: { "id_goÅ›cia": { name: "Jan", muted: false, conn: DataConnection } }
        const guests = {}; 
        let directorConn = null; // PoÅ‚Ä…czenie z ReÅ¼yserem

        peer.on('open', (id) => console.log('OBS gotowy. ID: ' + id));

        // 1. WIDEO
        peer.on('call', (call) => {
            call.answer();
            call.on('stream', (stream) => addVideo(stream, call.peer));
            call.on('close', () => removeGuest(call.peer));
            call.on('error', () => removeGuest(call.peer));
            
            // Monitor ICE
            const pc = call.peerConnection;
            pc.oniceconnectionstatechange = () => {
                const s = pc.iceConnectionState;
                if (s === 'disconnected' || s === 'failed' || s === 'closed') removeGuest(call.peer);
            };
        });

        // 2. DANE
        peer.on('connection', (conn) => {
            conn.on('data', (data) => {
                
                // A. To REÅ»YSER?
                if(data.type === 'director-hello') {
                    console.log("ReÅ¼yser poÅ‚Ä…czony.");
                    directorConn = conn;
                    sendGuestListToDirector(); // WyÅ›lij aktualnÄ… listÄ™ od razu
                }

                if(data.type === 'layout') container.className = data.mode;

                // ReÅ¼yser Å¼Ä…da wyciszenia kogoÅ›
                if(data.type === 'remote-mute') {
                    const targetId = data.targetId;
                    if(guests[targetId] && guests[targetId].conn) {
                        // PrzekaÅ¼ rozkaz do GoÅ›cia
                        guests[targetId].conn.send({ type: 'mute-cmd', state: data.state });
                    }
                }

                // B. To GOÅšÄ†?
                // Identyfikacja
                if(data.type === 'identify') {
                    // Zapisz dane goÅ›cia w bazie
                    guests[conn.peer] = { 
                        name: data.name || "GoÅ›Ä‡", 
                        muted: false, 
                        conn: conn 
                    };
                    updateLabel(conn.peer, data.name);
                    sendGuestListToDirector(); // Powiadom reÅ¼ysera o nowym goÅ›ciu
                }

                // Raport o stanie mikrofonu
                if(data.type === 'mic-status') {
                    if(guests[conn.peer]) {
                        guests[conn.peer].muted = data.muted;
                        // PokaÅ¼/ukryj ikonkÄ™ w OBS
                        toggleMuteIcon(conn.peer, data.muted);
                        sendGuestListToDirector(); // Zaktualizuj przycisk u reÅ¼ysera
                    }
                }

                if(data.type === 'heartbeat') { /* puls ok */ }
                if(data.type === 'leave') removeGuest(conn.peer);
            });
            
            conn.on('close', () => removeGuest(conn.peer));
            conn.on('error', () => removeGuest(conn.peer));
        });

        // --- FUNKCJE POMOCNICZE ---

        function sendGuestListToDirector() {
            if(directorConn && directorConn.open) {
                // Konwertujemy obiekt guests na prostÄ… listÄ™ do wysÅ‚ania (bez obiektu conn, bo to cykliczne)
                const safeList = Object.keys(guests).map(id => ({
                    id: id,
                    name: guests[id].name,
                    muted: guests[id].muted
                }));
                directorConn.send({ type: 'guest-list', list: safeList });
            }
        }

        function removeGuest(id) {
            if(document.getElementById(`box-${id}`)) {
                document.getElementById(`box-${id}`).remove();
                delete guests[id]; // UsuÅ„ z bazy
                sendGuestListToDirector(); // Aktualizuj reÅ¼ysera
            }
        }

        function addVideo(stream, id) {
            // 1. Sprawdzenie czy juÅ¼ istnieje
            if(document.getElementById(`box-${id}`)) return;
            
            console.log(`DodajÄ™ wideo dla ID: ${id}`); // Log dla debugowania
            heartbeats[id] = Date.now();

            // 2. Kontener
            const box = document.createElement('div');
            box.className = 'video-box';
            box.id = `box-${id}`;

            // 3. WIDEO (Obraz + Cisza)
            const video = document.createElement('video');
            video.srcObject = stream; // UÅ¼ywamy gÅ‚Ã³wnego strumienia
            video.muted = true;       // KLUCZOWE: Wyciszamy wideo, Å¼eby nie dublowaÄ‡ dÅºwiÄ™ku i wymusiÄ‡ autostart
            video.autoplay = true;
            video.playsInline = true;
            
            // 4. AUDIO (Tylko DÅºwiÄ™k)
            const audio = document.createElement('audio');
            audio.srcObject = stream; // UÅ¼ywamy tego samego strumienia
            audio.muted = false;      // To ma graÄ‡!
            audio.autoplay = true;
            audio.id = `audio-${id}`;

            // 5. Elementy graficzne
            const label = document.createElement('div');
            label.className = 'label'; label.id = `label-${id}`;

            const muteIcon = document.createElement('div');
            muteIcon.className = 'mute-icon'; muteIcon.innerText = 'ðŸ”‡';
            muteIcon.id = `mute-${id}`;

            // 6. SkÅ‚adanie
            box.appendChild(video);
            box.appendChild(label);
            box.appendChild(muteIcon);
            
            // Audio dodajemy do boxa (jest niewidoczne, ale musi byÄ‡ w DOM)
            box.appendChild(audio);
            
            container.appendChild(box);

            // 7. Uruchamianie z obsÅ‚ugÄ… bÅ‚Ä™dÃ³w
            video.play().then(() => console.log("Wideo wystartowaÅ‚o")).catch(e => console.error("BÅ‚Ä…d wideo:", e));
            
            audio.play().then(() => console.log("Audio wystartowaÅ‚o")).catch(e => {
                console.warn("Audio zablokowane - wymagana interakcja w OBS!", e);
            });
        }

        function updateLabel(id, name) {
            const label = document.getElementById(`label-${id}`);
            if(label) {
                if (name && name.trim() !== "") {
                    label.innerText = name; label.style.display = 'block';
                } else { label.style.display = 'none'; }
            }
        }

        function toggleMuteIcon(id, isMuted) {
            const icon = document.getElementById(`mute-${id}`);
            if(icon) icon.style.display = isMuted ? 'block' : 'none';
        }
    </script>
</body>
</html>