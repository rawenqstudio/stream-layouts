<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>WIDOK OBS (DEBUG)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #111; color: white; font-family: monospace; }
        
        #video-container { width: 100%; height: 100%; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; }
        
        video { 
            object-fit: cover; 
            border: 2px solid red; /* Czerwona ramka = wideo jest w DOM */
            background: #000; 
            max-width: 45%; max-height: 45%;
        }

        /* Panel diagnostyczny na górze */
        #debug-panel {
            position: absolute; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); z-index: 9999; padding: 10px; font-size: 12px; pointer-events: none;
        }
        #force-play-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 9999; padding: 20px; background: red; color: white; border: none; font-size: 20px; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="debug-panel">Czekam na połączenie... (Wersja Debug v2)</div>
    <button id="force-play-btn" onclick="forcePlay()">⚠️ KLIKNIJ TU JEŚLI CZARNO</button>

    <div id="video-container"></div>

    <script>
        function log(msg) {
            document.getElementById('debug-panel').innerText = msg;
            console.log(msg);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const myID = urlParams.get('room') || 'test-room';
        const container = document.getElementById('video-container');

        // KONFIGURACJA TURN (Open Relay)
        const turnConfig = [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
        ];

        const peer = new Peer(myID, { config: { iceServers: turnConfig }, debug: 2 });

        peer.on('open', (id) => {
            log(`OBS Gotowy. ID: ${id}. Czekam na gości...`);
        });

        peer.on('error', (err) => {
            log(`Błąd PeerJS: ${err.type}`);
        });

        peer.on('call', (call) => {
            log("Ktoś dzwoni! Odbieram...");
            call.answer(); 
            
            call.on('stream', (remoteStream) => {
                log("Otrzymano strumień (Stream)! Przetwarzanie...");
                addVideo(remoteStream, call.peer);
            });

            call.on('error', (err) => log("Błąd połączenia: " + err));
        });

        // Obsługa danych (układów)
        peer.on('connection', (conn) => {
            conn.on('data', (data) => {
                if(data.type === 'layout') container.className = data.mode;
            });
        });

        function addVideo(stream, id) {
            if(document.getElementById(`vid-${id}`)) return;

            log(`Dodaję element VIDEO dla ID: ${id}`);

            const video = document.createElement('video');
            video.srcObject = stream;
            video.id = `vid-${id}`;
            video.muted = true;  // WAŻNE
            video.autoplay = true;
            video.playsInline = true;

            // Zdarzenia diagnostyczne wideo
            video.onloadedmetadata = () => {
                log(`Metadane wideo załadowane. Rozdzielczość: ${video.videoWidth}x${video.videoHeight}`);
                video.play().catch(e => log("Autoplay zablokowany: " + e));
            };
            
            video.onresize = () => {
                log(`Zmiana rozdzielczości: ${video.videoWidth}x${video.videoHeight}`);
            };

            container.appendChild(video);
        }

        // Funkcja ratunkowa
        window.forcePlay = function() {
            const videos = document.querySelectorAll('video');
            videos.forEach(v => {
                v.muted = true;
                v.play()
                .then(() => log("Wymuszono start wideo!"))
                .catch(e => log("Błąd wymuszenia: " + e));
            });
        }
    </script>
</body>
</html>