<!doctype html><html lang="pl"><head><meta charset="UTF-8"><title>WIDOK OBS</title><script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script><style>*{box-sizing:border-box}body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:0 0;font-family:"Segoe UI",sans-serif}#video-container{width:100%;height:100%;transition:all .5s ease;position:relative}.video-box{position:relative;overflow:hidden;border:2px solid #fff;box-shadow:0 0 15px rgba(0,0,0,.7);background:#000;transition:all .5s ease}img.fake-cam,video{width:100%;height:100%;object-fit:cover;display:block}img.mirror-effect,video.mirror-effect{transform:scaleX(-1)}.mute-icon{position:absolute;top:10px;right:10px;color:red;font-size:24px;background:rgba(0,0,0,.5);padding:5px;border-radius:50%;display:none;z-index:20}.label{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,.7);color:#fff;padding:5px 15px;border-radius:4px;font-size:1.2rem;font-weight:700;text-shadow:1px 1px 2px #000;border-left:4px solid #00d2ff;z-index:10;display:none}#video-container:not(.show-labels) .label{display:none!important}#video-container:not(.show-icons) .mute-icon{display:none!important}.game-card{position:absolute;top:5%;left:50%;transform:translateX(-50%);background:#ffeb3b;color:#000;padding:10px 20px;font-size:2em;font-weight:800;text-transform:uppercase;border-radius:5px;box-shadow:0 5px 15px rgba(0,0,0,.5);z-index:50;text-align:center;border:2px solid #fdd835;animation:popIn .5s cubic-bezier(.175,.885,.32,1.275);white-space:nowrap}.game-card.self-hidden{opacity:0!important;pointer-events:none}@keyframes popIn{0%{transform:translateX(-50%) scale(0) rotate(-10deg);opacity:0}100%{transform:translateX(-50%) scale(1) rotate(0);opacity:1}}.layout-free{position:relative;width:100%;height:100%}.layout-free .video-box{position:absolute;transition:width .2s,height .2s,top .1s,left .1s;width:320px;height:180px;box-shadow:0 0 5px rgba(0,0,0,.8)}.layout-grid{display:flex;flex-wrap:wrap;justify-content:center;align-content:center;gap:15px;padding:20px}.layout-grid .video-box{width:45%;height:45%}.layout-grid[data-count="1"] .video-box{width:85%;height:85%}.layout-grid[data-count="2"] .video-box{width:48%;height:60%}.layout-grid[data-count="3"] .video-box,.layout-grid[data-count="4"] .video-box{width:45%;height:45%}.layout-grid[data-count="5"] .video-box,.layout-grid[data-count="6"] .video-box{width:32%;height:45%}.layout-grid[data-count="7"] .video-box,.layout-grid[data-count="8"] .video-box,.layout-grid[data-count="9"] .video-box{width:32%;height:30%}.layout-grid[data-count="10"] .video-box,.layout-grid[data-count="11"] .video-box,.layout-grid[data-count="12"] .video-box{width:23%;height:23%}.layout-sidebar-right{display:flex;flex-direction:column;justify-content:center;align-items:flex-end;padding-right:20px;height:100vh;gap:15px}.layout-sidebar-right .video-box{width:320px;height:180px;margin:0}.layout-sidebar-left{display:flex;flex-direction:column;justify-content:center;align-items:flex-start;padding-left:20px;height:100vh;gap:15px}.layout-sidebar-left .video-box{width:320px;height:180px;margin:0}.layout-bottom{display:flex;flex-direction:row;justify-content:center;align-items:flex-end;padding-bottom:20px;height:100vh;gap:20px}.layout-bottom .video-box{width:280px;height:157px;margin:0}.layout-top{display:flex;flex-direction:row;justify-content:center;align-items:flex-start;padding-top:20px;height:100vh;gap:20px}.layout-top .video-box{width:280px;height:157px;margin:0}.layout-split{display:grid;grid-template-columns:320px 1fr 320px;grid-auto-rows:min-content;align-content:center;row-gap:30px;padding:20px 40px;height:100vh}.layout-split .video-box{width:100%;height:180px;margin:0}.layout-split .video-box:nth-child(odd){grid-column:1;justify-self:start}.layout-split .video-box:nth-child(2n){grid-column:3;justify-self:end}.layout-center-stage{display:grid;grid-template-columns:300px 1fr 300px;grid-auto-rows:min-content;gap:15px;padding:20px;height:100vh;align-content:center}.layout-center-stage .video-box{width:100%;height:169px;margin:0}.layout-center-stage .video-box:first-child{grid-column:2;grid-row:1/span 10;width:100%;height:auto;max-height:90vh;aspect-ratio:16/9;align-self:center;z-index:10;box-shadow:0 0 30px rgba(0,0,0,.8)}.layout-center-stage .video-box:nth-child(2n){grid-column:1}.layout-center-stage .video-box:nth-child(odd):not(:first-child){grid-column:3}</style></head><body><div id="video-container" class="layout-grid" data-count="0"></div><script>const urlParams=new URLSearchParams(window.location.search),myID=urlParams.get("room")||"test-room",useStunOnly=urlParams.get("stunonly"),useULL=urlParams.get("ull"),isMulti=urlParams.get("multi"),hideTargetName=urlParams.get("hide")?urlParams.get("hide").toLowerCase().trim():null,selectedConfig=useStunOnly?[{urls:"stun:stun.l.google.com:19302"}]:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:openrelay.metered.ca:80?transport=udp",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:openrelay.metered.ca:80?transport=tcp",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:openrelay.metered.ca:443?transport=udp",username:"openrelayproject",credential:"openrelayproject"},{urls:"turn:openrelay.metered.ca:443?transport=tcp",username:"openrelayproject",credential:"openrelayproject"}],peer=new Peer(isMulti?void 0:myID,{config:{iceServers:selectedConfig}}),container=document.getElementById("video-container"),guests={},heartbeats={};let directorConn=null;const statsCache={};function connectToDirector(e){directorConn=peer.connect(e),directorConn.on("open",()=>{console.log("PoÅ‚Ä…czono z ReÅ¼yserem."),directorConn.send({type:"register-obs"})}),directorConn.on("data",e=>handleData(e))}function handleData(e,t){if("layout"===e.type&&(container.className=e.mode,"layout-free"!==e.mode&&document.querySelectorAll(".video-box").forEach(e=>{e.style.top="",e.style.left="",e.style.width="",e.style.height=""})),"transform-update"===e.type){const t=document.getElementById(`box-${e.targetId}`);t&&(t.style.left=e.x+"%",t.style.top=e.y+"%",t.style.width=e.w+"%",t.style.height=e.h+"%")}if("toggle-labels"===e.type&&(e.show?container.classList.add("show-labels"):container.classList.remove("show-labels")),"toggle-icons"===e.type&&(e.show?container.classList.add("show-icons"):container.classList.remove("show-icons")),"reorder-guests"===e.type&&e.order.forEach(e=>{const t=document.getElementById(`box-${e}`);t&&container.appendChild(t)}),"add-fake-guest"===e.type&&addFakeVideo(e.id,e.name,e.img),"refresh-cam"===e.type&&("all"===e.targetId?Object.keys(guests).forEach(e=>performRefresh(e)):performRefresh(e.targetId)),"toggle-mirror"===e.type){const t=document.getElementById(`box-${e.targetId}`);if(t){const o=t.querySelector("video")||t.querySelector("img");o&&(o.classList.toggle("mirror-effect"),guests[e.targetId]&&(guests[e.targetId].mirrored=o.classList.contains("mirror-effect")),sendGuestListToDirector())}}if("game-deal"===e.type){document.querySelectorAll(".game-card").forEach(e=>e.remove());for(const[t,o]of Object.entries(e.cards))setGameCard(t,o)}if("game-update-card"===e.type&&setGameCard(e.targetId,e.word),"game-clear"===e.type&&document.querySelectorAll(".game-card").forEach(e=>e.remove()),"remote-mute"===e.type&&guests[e.targetId]&&guests[e.targetId].conn&&guests[e.targetId].conn.send({type:"mute-cmd",state:e.state}),"identify"===e.type&&t){guests[t.peer]||(guests[t.peer]={name:"GoÅ›Ä‡",muted:!1,mirrored:!1}),guests[t.peer].name=e.name||"GoÅ›Ä‡",guests[t.peer].conn=t,updateLabel(t.peer,e.name);const o=document.getElementById(`box-${t.peer}`);if(o){const t=o.querySelector(".game-card");t&&hideTargetName&&e.name.toLowerCase().trim()===hideTargetName&&t.classList.add("self-hidden")}sendGuestListToDirector()}"mic-status"===e.type&&t&&guests[t.peer]&&(guests[t.peer].muted=e.muted,toggleMuteIcon(t.peer,e.muted),sendGuestListToDirector()),"heartbeat"===e.type&&t&&(heartbeats[t.peer]=Date.now()),"leave"===e.type&&t&&removeGuest(t.peer)}function setGameCard(e,t){const o=document.getElementById(`box-${e}`);if(!o)return;let n=o.querySelector(".game-card");n&&n.remove();const r=document.createElement("div");r.className="game-card",r.innerText=t,hideTargetName&&guests[e]&&guests[e].name&&guests[e].name.toLowerCase().trim()===hideTargetName&&r.classList.add("self-hidden"),o.appendChild(r)}function updateGuestCount(){const e=container.querySelectorAll(".video-box").length;container.setAttribute("data-count",e)}function addFakeVideo(e,t,o){if(document.getElementById(`box-${e}`))return;guests[e]={name:t,muted:!1,mirrored:!1,conn:null};const n=document.createElement("div");n.className="video-box",n.id=`box-${e}`,n.style.order=999;const r=document.createElement("img");r.src=o,r.className="fake-cam";const a=document.createElement("div");a.className="label",a.id=`label-${e}`,a.innerText=t;const s=document.createElement("div");s.className="mute-icon",s.innerText="ðŸ”‡",s.id=`mute-${e}`,n.appendChild(r),n.appendChild(a),n.appendChild(s),container.appendChild(n),updateGuestCount(),sendGuestListToDirector()}function addVideo(e,t){if(document.getElementById(`box-${t}`))return;heartbeats[t]=Date.now(),statsCache[t]={bytes:0,delayTotal:0,emittedTotal:0};const o=document.createElement("div");o.className="video-box",o.id=`box-${t}`,o.style.order=999;const n=document.createElement("video");n.srcObject=e,n.muted=!0,n.autoplay=!0,n.playsInline=!0;const r=document.createElement("audio");r.srcObject=e,r.muted=!1,r.autoplay=!0,r.id=`audio-${t}`;const a=document.createElement("div");a.className="label",a.id=`label-${t}`;const s=document.createElement("div");s.className="mute-icon",s.innerText="ðŸ”‡",s.id=`mute-${t}`,o.appendChild(n),o.appendChild(a),o.appendChild(s),o.appendChild(r),container.appendChild(o),updateGuestCount(),n.play().catch(e=>console.error(e)),r.play().catch(e=>console.warn(e))}function performRefresh(e){const t=document.getElementById(`box-${e}`);if(!t)return;const o=t.querySelector("video"),n=t.querySelector("audio");if(o&&o.srcObject){const e=o.srcObject;o.srcObject=null,n&&(n.srcObject=null),setTimeout(()=>{o.srcObject=e,n&&(n.srcObject=e),o.play().catch(e=>console.log(e)),n&&n.play().catch(e=>console.log(e))},100)}}function removeGuest(e){document.getElementById(`box-${e}`)&&(document.getElementById(`box-${e}`).remove(),delete guests[e],delete heartbeats[e],delete statsCache[e],updateGuestCount(),sendGuestListToDirector())}function updateLabel(e,t){const o=document.getElementById(`label-${e}`);o&&(t&&""!==t.trim()?(o.innerText=t,o.style.display="block"):o.style.display="none")}function toggleMuteIcon(e,t){const o=document.getElementById(`mute-${e}`);o&&(o.style.display=t?"block":"none")}function sendGuestListToDirector(){if(directorConn&&directorConn.open){const e=Object.keys(guests).map(e=>({id:e,name:guests[e].name,muted:guests[e].muted,mirrored:guests[e].mirrored}));directorConn.send({type:"guest-list",list:e})}}peer.on("open",e=>{console.log("OBS gotowy. ID: "+e),isMulti&&connectToDirector(myID)}),peer.on("call",e=>{e.answer(),guests[e.peer]||(guests[e.peer]={name:"ÅÄ…czenie...",muted:!1,mirrored:!1,conn:null}),guests[e.peer].call=e,useULL&&setTimeout(()=>{const t=e.peerConnection;t&&t.getReceivers&&t.getReceivers().forEach(e=>{e.track&&"video"===e.track.kind&&"playoutDelayHint"in e&&(e.playoutDelayHint=0)})},500),e.on("stream",t=>addVideo(t,e.peer)),e.on("close",()=>removeGuest(e.peer)),e.on("error",()=>removeGuest(e.peer));const t=e.peerConnection;t.oniceconnectionstatechange=()=>{const o=t.iceConnectionState;"disconnected"!==o&&"failed"!==o&&"closed"!==o||removeGuest(e.peer)}}),peer.on("connection",e=>{e.on("data",t=>{"director-hello"===t.type&&(directorConn=e,sendGuestListToDirector()),handleData(t,e)}),e.on("close",()=>removeGuest(e.peer)),e.on("error",()=>removeGuest(e.peer))}),setInterval(async()=>{const e=Date.now(),t={};for(const o in guests){if(o.startsWith("fake-"))continue;if(heartbeats[o]&&e-heartbeats[o]>7e3){removeGuest(o);continue}const n=guests[o];if(n.call&&n.call.peerConnection)try{const e=await n.call.peerConnection.getStats();let r=null;if(e.forEach(e=>{"inbound-rtp"===e.type&&"video"===e.kind&&(r=e)}),r){const e=r.bytesReceived,n=8*(e-(statsCache[o]?.bytes||0))/1e3,a=r.jitterBufferDelay||0,s=r.jitterBufferEmittedCount||1,c=statsCache[o]?.delayTotal||0,d=statsCache[o]?.emittedTotal||0,l=s-d;let i=0;l>0&&(i=(a-c)/l);const u=document.getElementById(`box-${o}`);if(u){const e=u.querySelector("video");e&&!e.paused&&(i>.2?1.05!==e.playbackRate&&(e.playbackRate=1.05):i<.15&&1!==e.playbackRate&&(e.playbackRate=1),i>2&&performRefresh(o))}statsCache[o]={bytes:e,delayTotal:a,emittedTotal:s},t[o]={bitrate:Math.round(n),packetLoss:r.packetsLost||0,resolution:r.frameWidth&&r.frameHeight?`${r.frameWidth}x${r.frameHeight}`:"N/A"}}}catch(e){}}directorConn&&directorConn.open&&Object.keys(t).length>0&&directorConn.send({type:"stats-update",stats:t})},1e3)</script></body></html>