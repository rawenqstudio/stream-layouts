<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Kamera Go≈õcia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #111; color: white; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        video { width: 100%; border-radius: 10px; background: #000; border: 2px solid #333; margin: 20px 0; }
        button { background: #00d2ff; color: #000; border: none; padding: 15px 30px; font-size: 1.2em; border-radius: 30px; cursor: pointer; font-weight: bold; width: 100%; }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        .status { margin-top: 10px; color: #aaa; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üé• Twoja Kamera</h2>
        <video id="localVideo" autoplay muted playsinline></video>
        <button id="join-btn" onclick="startStream()">DO≈ÅƒÑCZ DO STUDIA</button>
        <div id="status" class="status">Gotowy. Kliknij przycisk powy≈ºej.</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('room');
        const statusDiv = document.getElementById('status');
        const btn = document.getElementById('join-btn');

        if(!roomID) {
            statusDiv.innerText = "B≈ÅƒÑD: Nieprawid≈Çowy link (brak ID pokoju).";
            btn.disabled = true;
        }

        // --- TA SAMA KONFIGURACJA CO W OBS ---
        const freeIceConfig = [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            {
                urls: "turn:openrelay.metered.ca:443?transport=tcp",
                username: "openrelayproject",
                credential: "openrelayproject"
            },
            {
                urls: "turn:openrelay.metered.ca:80",
                username: "openrelayproject",
                credential: "openrelayproject"
            }
        ];

        const peer = new Peer({ 
            config: { iceServers: freeIceConfig, iceTransportPolicy: 'all' } 
        });

        function startStream() {
            btn.disabled = true;
            statusDiv.innerText = "Proszƒô o dostƒôp do kamery...";

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                document.getElementById('localVideo').srcObject = stream;
                statusDiv.innerText = "Kamera OK. ≈ÅƒÖczenie z OBS...";

                const call = peer.call(roomID, stream);

                call.on('close', () => {
                    statusDiv.innerText = "Po≈ÇƒÖczenie zako≈Ñczone.";
                    btn.disabled = false;
                });
                
                call.on('error', (err) => {
                    statusDiv.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia: " + err;
                    btn.disabled = false;
                });
                
                // Monitorujemy, czy po≈ÇƒÖczenie siƒô uda≈Ço (PeerJS internal)
                setTimeout(() => {
                    if(call.peerConnection.iceConnectionState === 'connected' || call.peerConnection.iceConnectionState === 'completed') {
                         statusDiv.innerText = "‚úÖ JESTE≈ö NA ≈ªYWO (Po≈ÇƒÖczono)";
                         statusDiv.style.color = "#00ff00";
                    }
                }, 3000); // Sprawd≈∫ po 3 sekundach
            })
            .catch((err) => {
                console.error(err);
                statusDiv.innerText = "B≈ÇƒÖd kamery: " + err.message;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>