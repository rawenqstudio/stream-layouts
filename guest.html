<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>GOŚĆ (DIAGNOSTYKA TURN)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 10px; font-size: 12px; }
        video { width: 100%; border: 2px solid #555; margin-bottom: 10px; background: #000; }
        #logs { border-top: 1px solid #555; padding-top: 10px; white-space: pre-wrap; word-break: break-all; }
        .error { color: #ff5555; background: #200; }
        .relay { color: #ffff00; font-weight: bold; } /* Wyróżniamy Relay na żółto */
        button { padding: 15px; width: 100%; font-size: 16px; margin-bottom: 10px; cursor: pointer; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>
    <h3>Diagnostyka LTE/TURN</h3>
    <video id="localVideo" autoplay muted playsinline></video>
    
    <input type="text" id="target-id" placeholder="ID Pokoju">
    <button onclick="startCall()">POŁĄCZ (Start Test)</button>
    
    <div id="logs">Logi pojawią się tutaj...</div>

    <script>
        function log(msg, type='') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            
            // Wyróżnianie kluczowych słów
            if(msg.includes('relay')) { 
                type = 'relay'; 
                msg = ">>> ZNALEZIONO TURN (RELAY): " + msg;
            }
            if(type) div.className = type;
            
            div.innerText = `${new Date().toLocaleTimeString()} - ${msg}`;
            logs.prepend(div); // Najnowsze na górze
        }

        // --- KONFIGURACJA ---
        const MY_METERED_USER = "6d29fb99ae677ec0acd6e982"; // <--- SPRAWDŹ CZY NIE MA SPACJI!
        const MY_METERED_PASS = "6MZCO1eecPhRF7yT"; // <--- SPRAWDŹ CZY NIE MA SPACJI!

        const turnConfig = [
            { urls: "stun:stun.l.google.com:19302" },
            { 
                urls: "turn:global.turn.metered.ca:80",
                username: MY_METERED_USER,
                credential: MY_METERED_PASS
            },
            { 
                urls: "turn:global.turn.metered.ca:443",
                username: MY_METERED_USER,
                credential: MY_METERED_PASS
            },
            { 
                urls: "turn:global.turn.metered.ca:443?transport=tcp",
                username: MY_METERED_USER,
                credential: MY_METERED_PASS
            }
        ];

        // Dodajemy opcję debug: 3, żeby widzieć wszystko
        const peer = new Peer({ 
            config: { iceServers: turnConfig }, 
            debug: 3 
        });

        // Nasłuchiwanie na własne kandydatury (To nam powie czy TURN działa)
        peer.on('open', (id) => {
            log(`Moje ID: ${id}`);
            log("Czekam na nawiązanie połączenia...");
            
            // Automatyczne pobranie ID z URL
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('room')) document.getElementById('target-id').value = urlParams.get('room');
        });

        peer.on('error', (err) => log("BŁĄD PEER: " + err.type, 'error'));

        function startCall() {
            const targetId = document.getElementById('target-id').value;
            if(!targetId) return alert("Brak ID!");

            log("Pobieram kamerę...");
            navigator.mediaDevices.getUserMedia({video: true, audio: true})
            .then(stream => {
                document.getElementById('localVideo').srcObject = stream;
                log("Kamera OK. Dzwonię...");

                const call = peer.call(targetId, stream);

                // --- KLUCZOWE: Śledzenie ICE Candidates ---
                // PeerJS ukrywa to normalnie, ale możemy podglądnąć obiekt connection
                call.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        const c = event.candidate;
                        log(`Kandydat: ${c.type} (${c.protocol}) ${c.address}`);
                    } else {
                        log("Koniec szukania kandydatów (Gathering Complete).");
                    }
                };

                call.peerConnection.oniceconnectionstatechange = () => {
                    log(`Stan połączenia: ${call.peerConnection.iceConnectionState}`);
                };

                call.on('stream', () => log("Odebrano wideo zwrotne (SUKCES!)", 'relay'));
                call.on('close', () => log("Połączenie zamknięte"));
                call.on('error', (e) => log("Błąd Call: " + e, 'error'));
            })
            .catch(e => log("Błąd kamery: " + e, 'error'));
        }
    </script>
</body>
</html>