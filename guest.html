<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>GOŚĆ (FINAL TEST)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 10px; font-size: 11px; }
        video { width: 100%; border: 2px solid #555; margin-bottom: 10px; background: #222; }
        #logs { border-top: 1px solid #555; padding-top: 10px; white-space: pre-wrap; word-break: break-all; }
        .relay { color: #ffff00; font-weight: bold; background: #330; padding: 2px; } 
        .error { color: #ff5555; font-weight: bold; }
        button { padding: 20px; width: 100%; font-size: 18px; font-weight: bold; background: #004400; color: white; border: none; margin-bottom: 10px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; color: black;}
    </style>
</head>
<body>
    <h3>TEST LTE (WYMUSZENIE TCP)</h3>
    <video id="localVideo" autoplay muted playsinline></video>
    
    <input type="text" id="target-id" placeholder="ID Pokoju">
    <button onclick="startCall()">POŁĄCZ</button>
    
    <div id="logs">Czekam...</div>

    <script>
        function log(msg, type='') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            
            if(msg.includes('relay')) { 
                type = 'relay'; 
                msg = ">>> SUKCES! MAMY TURN (RELAY): " + msg;
            }
            if(type) div.className = type;
            
            div.innerText = `${new Date().toLocaleTimeString()} - ${msg}`;
            logs.prepend(div);
        }

        // --- KONFIGURACJA NA SZTYWNO (WPISZ DANE PONIŻEJ) ---
        // Upewnij się, że username i credential są w cudzysłowach!
        
        const iceServersConfig = [
            // 1. Najpierw próbujemy TCP (największa szansa na LTE)
            { 
                urls: "turn:global.turn.metered.ca:443?transport=tcp",
                username: "6d29fb99ae677ec0acd6e982",
                credential: "6MZCO1eecPhRF7yT"
            },
            // 2. Potem zwykły UDP na porcie 80 (omijanie firewalli)
            { 
                urls: "turn:global.turn.metered.ca:80",
                username: "6d29fb99ae677ec0acd6e982",
                credential: "6MZCO1eecPhRF7yT"
            },
            // 3. Standardowy UDP
            { 
                urls: "turn:global.turn.metered.ca:443",
                username: "6d29fb99ae677ec0acd6e982",
                credential: "6MZCO1eecPhRF7yT"
            },
            // 4. STUN Google jako backup
            { urls: "stun:stun.l.google.com:19302" }
        ];

        // Wyświetl konfigurację w logach, żeby sprawdzić czy nie jest pusta
        console.log("Moja konfiguracja ICE:", iceServersConfig);

        const peer = new Peer({ 
            config: { 
                iceServers: iceServersConfig,
                iceTransportPolicy: 'relay' // Opcjonalnie: wymuś TYLKO relay do testów (ryzykowne, ale pewne)
            }, 
            debug: 3 
        });

        peer.on('open', (id) => {
            log(`Moje ID: ${id}`);
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('room')) document.getElementById('target-id').value = urlParams.get('room');
        });

        peer.on('error', (err) => log("BŁĄD PEER: " + err.type + " - " + err.message, 'error'));

        function startCall() {
            const targetId = document.getElementById('target-id').value;
            if(!targetId) return alert("Brak ID!");

            log("Start kamery...");
            navigator.mediaDevices.getUserMedia({video: true, audio: true})
            .then(stream => {
                document.getElementById('localVideo').srcObject = stream;
                log("Kamera OK. Szukam drogi (Gathering)...");

                const call = peer.call(targetId, stream);

                call.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        const c = event.candidate;
                        // Logujemy typ kandydata
                        let typeInfo = c.type;
                        if(typeInfo === 'relay') typeInfo = 'RELAY (TURN) !!!';
                        log(`Znalazłem drogę: ${typeInfo} (${c.protocol})`);
                    } else {
                        log("Koniec szukania dróg.");
                    }
                };

                call.peerConnection.oniceconnectionstatechange = () => {
                    log(`Stan połączenia: ${call.peerConnection.iceConnectionState}`);
                };
                
                call.on('stream', () => log("Odebrano wideo zwrotne!", 'relay'));
            })
            .catch(e => log("Błąd kamery: " + e, 'error'));
        }
    </script>
</body>
</html>