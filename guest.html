<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOŚĆ - Advanced Fallback</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: white; padding: 20px; margin: 0; }
        .container { background: #333; padding: 20px; border-radius: 10px; display: inline-block; max-width: 90%; }
        video { width: 100%; max-width: 400px; border: 2px solid #444; border-radius: 8px; margin-top: 20px; background: #000; }
        #logs { margin-top: 20px; color: #aaa; font-size: 0.8em; text-align: left; background: #111; padding: 10px; border-radius: 5px; height: 150px; overflow-y: auto; font-family: monospace; }
        .error { color: #ff4444; } .success { color: #00ff00; } .warning { color: #ffa500; }
        button { padding: 10px 20px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; }
        button:disabled { background: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Jesteś Gościem</h1>
        <video id="localVideo" autoplay muted playsinline></video>
        <br><br>
        <button id="join-btn" onclick="startCallProcess()">DOŁĄCZ DO STUDIA</button>
        <div id="logs">System gotowy.</div>
    </div>

    <script>
        function log(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const p = document.createElement('div');
            p.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type === 'error') p.className = 'error';
            if(type === 'success') p.className = 'success';
            if(type === 'warning') p.className = 'warning';
            logs.appendChild(p);
            logs.scrollTop = logs.scrollHeight;
            console.log(msg);
        }

        // --- KONFIGURACJA SERWERÓW ---
        const stunServers = [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "stun:stun1.l.google.com:19302" },
            { urls: "stun:openrelay.metered.ca:80" },
            { urls: "stun:stun.stunprotocol.org" }
        ];

        const turnServers = [
            { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
        ];

        let peer = null;
        let localStream = null;
        let connectionRetryCount = 0;
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('room');
        const isStunOnly = urlParams.has('stunonly');

        // Funkcja generująca config zależnie od trybu (Normal vs Forced TURN)
        function getPeerConfig(forceTurn = false) {
            let iceList = [...stunServers];
            let policy = 'all';

            if (isStunOnly) {
                log("Tryb: STUN-ONLY (wymuszony przez URL)", 'warning');
                // Nie dodajemy TURN
            } else {
                iceList = [...stunServers, ...turnServers];
                if (forceTurn) {
                    log("Tryb: FORCED TURN (Fallback aktywny!)", 'warning');
                    policy = 'relay'; // Wymuś użycie przekaźnika
                }
            }

            return {
                config: {
                    iceServers: iceList,
                    iceTransportPolicy: policy
                },
                debug: 1
            };
        }

        // Główna funkcja startowa
        async function startCallProcess() {
            if (!roomID) return log("Brak ID pokoju (?room=...)!", "error");
            
            document.getElementById('join-btn').disabled = true;

            try {
                if (!localStream) {
                    log("Pobieranie kamery...");
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    document.getElementById('localVideo').srcObject = localStream;
                }
                
                // Próba 1: Standardowa (lub STUN-only jeśli w URL)
                initPeerAndCall(false);

            } catch (err) {
                log("Błąd kamery: " + err, "error");
                document.getElementById('join-btn').disabled = false;
            }
        }

        function initPeerAndCall(forceTurn) {
            if (peer) peer.destroy(); // Czyścimy starą instancję

            const config = getPeerConfig(forceTurn);
            peer = new Peer(undefined, config);

            peer.on('open', (id) => {
                log(`Moje ID: ${id}. Dzwonię do ${roomID}...`);
                makeCall(roomID);
            });

            peer.on('error', (err) => {
                log(`Błąd PeerJS: ${err.type}`, 'error');
            });
        }

        function makeCall(targetId) {
            const call = peer.call(targetId, localStream);
            let watchdogTimer = null;
            let callConnected = false;

            // --- MONITOROWANIE STANU (FALLBACK LOGIC) ---
            
            // 1. Ustaw timer na 5 sekund
            watchdogTimer = setTimeout(() => {
                if (!callConnected) {
                    log("TIMEOUT: Połączenie niestabilne po 5s.", "error");
                    
                    // Jeśli jeszcze nie próbowaliśmy wymuszać TURN i nie jesteśmy w trybie stunonly
                    if (!connectionRetryCount && !isStunOnly) {
                        connectionRetryCount++;
                        log("FALLBACK: Rozłączam i próbuję ponownie przez TURN...", "warning");
                        
                        call.close();
                        // Restart z flagą forceTurn = true
                        initPeerAndCall(true); 
                    } else {
                        log("Nie udało się połączyć mimo prób.", "error");
                    }
                }
            }, 5000); // 5000 ms = 5 sekund

            // 2. Dostęp do natywnego obiektu RTCPeerConnection, by śledzić stan ICE
            // PeerJS tworzy call.peerConnection dopiero po chwili, więc czekamy
            setTimeout(() => {
                if (call.peerConnection) {
                    call.peerConnection.oniceconnectionstatechange = () => {
                        const state = call.peerConnection.iceConnectionState;
                        log(`ICE State: ${state}`);
                        
                        if (state === 'connected' || state === 'completed') {
                            callConnected = true;
                            clearTimeout(watchdogTimer);
                            log("SUKCES: Połączenie stabilne!", "success");
                            document.querySelector('video').style.borderColor = "#00ff00";
                        }
                        if (state === 'failed' || state === 'disconnected') {
                            // Tu też można wywołać fallback natychmiast
                        }
                    };
                }
            }, 500);

            call.on('close', () => {
                log("Rozłączono połączenie wideo.");
            });
            
            call.on('error', (err) => {
                log("Błąd Call: " + err, 'error');
            });
        }
    </script>
</body>
</html>